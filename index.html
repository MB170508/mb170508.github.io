<!DOCTYPE html>
<html>
    <head>
        <title>rpg</title>
        <script>
            async function getValidApiKey() {
                let key = localStorage.getItem("api_key");
                while (!await check(key)) {
                    window.open("https://www.openrouter.ai/keys");
                    key = prompt("Enter OpenRouter API key (openrouter.ai/keys)");
                    localStorage.setItem("api_key", key);
                }
                return key;
            }

            async function check(key) {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    headers: { Authorization: `Bearer ${key}` },
                    method: 'POST'
                });
                const value = await response.json();
                return value["error"]["code"] !== 401;
            }

            async function req(data) {
                const response = await fetch(
                    "https://openrouter.ai/api/v1/chat/completions",
                    {
                        headers: { Authorization: `Bearer ${localStorage.getItem("api_key")}` },
                        method: "POST",
                        body: JSON.stringify({
                            "model": "openchat/openchat-7b:free",
                            "messages": [
                                { "role": "system", "content": "You're an rpg text based game, you do not make decisions for the user. Your responses will always only be descriptions of the users actions and also describing the surroundings. Always end with explicitly and nothing else than 'What will you do?'. Your responses will correspond to the dialogue between the game and the user given to you with the action the user chose. Make up random threats or issues sometimes while preforming the users chosen action. Do not let the user preform activities that are out of human abilities or if he lacks items otherwise let him do anything. Let the user have his own morals you do not influence him or his actions and you do not preform actions for the user. Do not use 'game: ' at the beggining or ';' at the end of your response from the history when responding to the user. DO NOT COMMENT THE USERS CHOICES OR MORALITIES" },
                                { "role": "user", "content": data },
                            ]
                        }),
                    }
                );
                const result = await response.json();
                return result.choices[0].message.content.replace("\n","");
            }

            function createElement(type, properties, parent) {
                const element = document.createElement(type);
                Object.assign(element, properties);
                if (parent) {
                    parent.appendChild(element);
                }
                return element;
            }

            async function input() {
                const container = createElement("div", {id: "container"}, document.body);
                createElement("label", {for: "data", innerHTML: ">"}, container);
                const inp = createElement("input", {type: "text", id: "data", autocomplete: "off"}, container);
                await waitForKeypress("Enter");
                const usr = createElement("p", {style: "margin: 0px;", innerHTML: `>${inp.value}`}, document.body);
                container.remove();
                return usr.innerHTML.replace("&gt;","");
            }

            function waitForKeypress(key) {
                return new Promise((resolve) => {
                    document.addEventListener('keydown', function onKeyHandler(e) {
                        if (e.key === key) {
                            document.removeEventListener('keydown', onKeyHandler);
                            resolve();
                        }
                    });
                });
            }

            function saveToHistory(item) {
                localStorage.setItem("history", item);
            }

            function addToHistory(item) {
                const history = localStorage.getItem("history") + item + "\n";
                localStorage.setItem("history", history);
            }

            function print(cont) {
                createElement("p", {innerHTML: cont}, document.body);
            }

            window.onload = async () => {
                await getValidApiKey();
                let game = "";
                while (!["start", "continue"].includes(game)) {
                    game = await input();
                    if (game === "continue") {
                        const res = localStorage.getItem("last");
                        if (res) {
                            print(res);
                            act = await input();
                        } else {
                            game = "start";
                        }
                    }
                    if (game === "start") {
                        var act = "Make an opening scene starting in a forest";
                        localStorage.setItem("history", "");
                    }
                }
                while (act !== "0") {
                    const rsp = createElement("p", {innerHTML: "loading..."}, document.body);
                    game = await req(`dialogue history starting with the opening scene: '${localStorage.getItem("history")}' \nusers action: '${act}'`);
                    game = game.replace("\n\n","\n").replace("  "," ").replace("game: ","").trim();
                    addToHistory(`user: ${act}`);
                    addToHistory(`game: ${game.replace("\n"," ").replace("\r\n"," ")}`);
                    localStorage.setItem("last", game);
                    rsp.innerHTML = game;
                    act = await input();
                }
            }
        </script>
        <style>
            body { background-color: black; color: white; font-family: 'Courier New', Courier, monospace; }
            input { border: none; outline: none; background-color: black; color: white; width: auto; height: auto; font-family: 'Courier New', Courier, monospace; font-size: 1em; padding: 0px; }
            div { display: grid; grid-template-columns: min-content auto; }
        </style>
    </head>
    <body>
        <center>AI RPG</center>
        <p id="text">start, continue</p>
    </body>
</html>